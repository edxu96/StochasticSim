---
title: "How to Deal with Non-Business-Day Gaps"
author: "Edward J. Xu (<edxu96@outlook.com>)"
date: "`r Sys.Date()`"
documentclass: article
classoption: a4paper
output:
  html_notebook:
    code_folding: show
    df_print: paged
    fig_caption: no
    fig_height: 7.5
    fig_width: 15
    smooth_scroll: yes
    theme: default
    toc: yes
    toc_float: no
editor_options:
  chunk_output_type: inline
---

```{r, echo=F}
rm(list = ls())
setwd("~/GitHub/TidySimStat/examples/ARIMA")
```

```{r, message = FALSE}
## Basic packages
library(knitr)
library(kableExtra)
library(tidyverse)
library(magrittr)
library(tsibble)
library(lubridate)
## Specialized packages
library(forecast)
library(fable)
library(feasts)
library(fabletools)
library(stats)
library(gets)
```

## 1. Different Functions for Autoregressive Models 

A new index `i` is used.

```{r, warning=F, message=F, echo=T}
tsi <- read_csv("../../data/Fulton.csv") %>%
  # mutate(p = exp(LogPrice)) %>% 
  mutate(t = ymd(Date)) %>%
  mutate(p.log = LogPrice) %>%
  mutate(i = row_number()) %>%
  select(i, t, p.log) %>%
  as_tsibble(index = i)
```

```{r, message=F, echo=T, collapse=T}
mods <- list()

mods[[1]] <- tsi %>%
  {.$p.log} %>%
  ar.ols(aic = FALSE, order.max = 1, demean = F, intercept = T)

mods[[2]] <- tsi %>%
  {.$p.log} %>%
  ar.mle(aic = FALSE, order.max = 1, demean = T, intercept = F)
  # There is no way for `ar.mle` to estimate the intercept directly.

mods[[3]] <- tsi %>%
  {.$p.log} %>%
  arima(order = c(1, 0, 0), include.mean = T, method = "ML")
  # There is no way for `arima` to estimate the intercept directly.

mods[[4]] <- tsi %>%
  {.$p.log} %>%
  gets::arx(mc = T, ar = 1, mxreg = NULL, qstat.options = c(1,1))

mods[[5]] <- tsi %>%
  model(fable::ARIMA(p.log ~ 1 + pdq(1, 0, 0)))

mods[[6]] <- tsi %>%
  {.$p.log} %>%
  arima(order = c(1, 0, 0), include.mean = T, method = "CSS")
```

```{r, echo=F}
kable_inline <- function(ti){
  ti %>%
    mutate_if(is.numeric, format, digits = 4) %>%
    # mutate_if(is.numeric, round, 4) %>%
    kable() %>%
    kable_styling(full_width = F, 
      bootstrap_options = c("condensed", "responsive"))
}
```

```{r}
tibble(
  hwi_mods = 1:6,
  intercept = c(
    mods[[1]]$x.intercept, 
    as.double(mods[[2]]$x.mean) * (1 - as.double(mods[[2]]$ar)), 
    as.double(mods[[3]]$coef[2] * (1 - mods[[3]]$coef[1])), 
    mods[[4]]$coefficients[1], 
    as.double(coef(mods[[5]])[2, 3]), 
    as.double(mods[[6]]$coef[2] * (1 - mods[[6]]$coef[1]))
    ), 
  ar1 = c(
    mods[[1]]$ar[1], 
    as.double(mods[[2]]$ar), 
    as.double(mods[[3]]$coef[1]), 
    mods[[4]]$coefficients[2], 
    as.double(coef(mods[[5]])[1, 3]), 
    as.double(mods[[6]]$coef[1])
    )
  ) %>%
  kable_inline()
```

## 2. Fill Non-Business-Day Gaps with `NA`

```{r, warning=F, message=F, echo=T}
tsi_t <- read_csv("../../data/Fulton.csv") %>%
  # mutate(p = exp(LogPrice)) %>% 
  mutate(t = ymd(Date)) %>%
  mutate(p.log = LogPrice) %>%
  mutate(i = row_number()) %>%
  select(t, i, p.log) %>%
  as_tsibble(index = t)
```

When `t` is used as the index of `tsibble`, non-business-day (NBD) gaps will be detected. `fill_gaps()` can be used to fill `NA` values for NBD. See [Handle implicit missingness with tsibble](https://tsibble.tidyverts.org/articles/implicit-na.html) for details.

```{r}
tsi_t %>% fill_gaps() %>% head(14) %>% kable_inline()
```

If `fill_gaps()` is not used, when `fable::ARIMA` is applied, there will be an error stating that the data contains implicit gaps in time. You should check your data and convert implicit gaps into explicit missing values.

```{r}
mods[[7]] <- tsi_t %>%
  fill_gaps() %>%
  model(fable::ARIMA(p.log ~ 1 + pdq(1, 0, 0)))

mods[[7]] %>% tidy() %>% kable_inline()
```

However, because the existence of `NA` values, the above result turns out to be different from what we obtained in section 1.

```{r}
mods[[5]] %>% tidy() %>% kable_inline()
```

Whether to fill the NBD gaps depends on the context. [Forecasting time series with data on weekdays only, CrossValidated](https://stats.stackexchange.com/questions/327343/forecasting-time-series-with-data-on-weekdays-only). More advanced calendars may be used. [Calendarise self-defined date-times (e.g. business days and time) and respect structural missingness](https://github.com/tidyverts/tsibble/issues/18).


## 3. How to Visualize without NBD Gaps Filled

So if we don't want to fill NBD gaps, a nex index must be added like that in section 1. It is hard to use `autoplot()` with `t` specified as x axis. `ggplot()` must be used.

```{r}
tsi %>% ggplot() +
  geom_line(aes(t, p.log))
```

When using other functions in `feasts`, the univaraite time series must be specified.

```{r}
tsi %>% gg_tsdisplay(p.log)
```

```{r}
tsi %>% ACF(p.log) %>%
  autoplot()
```




